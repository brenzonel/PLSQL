--create or replace procedure fact_venta
--is
declare 
cursor f_vta is
select id_clte, valor, fecha_fact
from Factura_vta;
v_anio number;
v_mes varchar(5);
f_id_clt number;

begin
delete from venta_anual;
 for venta in f_vta loop
	v_anio := to_number(to_char(venta.fecha_fact,'yyyy'));
	v_mes := to_number(to_char(venta.fecha_fact,'mm'));
  begin 
	select id_cliente into f_id_clt
	from venta_anual
	where id_cliente = venta.id_clte and anio = v_anio;
	exception 
  when no_data_found then
  f_id_clt := null;
  end;
	--if f_vta%notfound then -----este found no se puede porque el sql es solo para insert, update y delete
  if f_id_clt is null then
		if v_mes = 01 then
			insert into venta_anual (id_cliente, anio, ene) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 02 then 
			insert into venta_anual (id_cliente, anio, feb) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 03 then 
			insert into venta_anual (id_cliente, anio, mar) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 04 then 
			insert into venta_anual (id_cliente, anio, abr) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 05 then 
			insert into venta_anual (id_cliente, anio, may) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 06 then 
			insert into venta_anual (id_cliente, anio, jun) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 07 then 
			insert into venta_anual (id_cliente, anio, jul) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 08 then 
			insert into venta_anual (id_cliente, anio, ago) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 09 then 
			insert into venta_anual (id_cliente, anio, sep) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 10 then 
			insert into venta_anual (id_cliente, anio, oct) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 11 then 
			insert into venta_anual (id_cliente, anio, nov) values (venta.id_clte, v_anio, venta.valor);
		elsif v_mes = 12 then 
			insert into venta_anual (id_cliente, anio, dic) values (venta.id_clte, v_anio, venta.valor);
		end if;

	else 
		
		if v_mes = 01 then
			update venta_anual set ene = nvl(ene,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 02 then 
			update venta_anual set feb = nvl(feb,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 03 then 
			update venta_anual set mar = nvl(mar,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 04 then 
			update venta_anual set abr = nvl(abr,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 05 then 
			update venta_anual set may = nvl(may,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 06 then 
			update venta_anual set jun = nvl(jun,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 07 then 
			update venta_anual set jul = nvl(jul,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 08 then 
			update venta_anual set ago = nvl(ago,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 09 then 
			update venta_anual set sep = nvl(sep,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 10 then 
			update venta_anual set oct = nvl(oct,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 11 then 
			update venta_anual set nov = nvl(nov,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		elsif v_mes = 12 then 
			update venta_anual set dic = nvl(dic,0) + venta.valor where ID_CLIENTE = venta.id_clte and anio = v_anio;
		end if;
	end if;
end loop;
end;