set  serveroutput on --PARA ACTIVAR LOS MENSAJES EN CONSOLA SOLO SE EJCUTA 1 VEZ
create or replace procedure cargar (opcion number) is
--declare
f2 utl_file.file_type; 
f1 utl_file.file_type;
v1 varchar (256); 
posicion_pipe_sig number;
posicion_pipe number;
tabla varchar (2);
c_id_clte number;
id_clte number;
/*variables de la tabla factura*/
f_fecha date;
f_folio number;
f_valor number;
f_estatus varchar (20);
/*variables de la tabla factura*/
/*variables de la tabla producto*/
p_folio number;
p_prod number;
p_valor number;
p_cantidad number;   
/*variables de la tabla producto*/
s number;
begin /******** PARA ELIMINAR LOS DATOS DE LAS TABLAS FACT_VTA Y PROD_VENTA Y PROBAR CON OPCION 1 Y OPCION 0 COMO PARAMETROS*******/
delete from BA_FACT_VTA;
delete from BA_PROD_VENTA;
/*******ELIMINAR CUANDO SEA NECESARIO********/
dbms_output.put_line(opcion);
f2 := utl_file.fopen ('URL_DIR','factura_producto.txt','r'); 
loop 
  utl_file.get_line(f2,v1); 
  dbms_output.put_line('se lee la linea de:');
  dbms_output.put_line(v1); 
  tabla := substr(v1,1,2);
  if tabla = 'FP' then --pregunto si es factura
      s := 3;
      posicion_pipe := instr(v1, '|');
      f_folio := to_number(substr(v1,3,posicion_pipe-3)); --consigo el folio
      dbms_output.put_line('FOLIO:');
      dbms_output.put_line(f_folio);
      posicion_pipe_sig := instr(v1,'|',s-1,2);
      s := posicion_pipe_sig;
      id_clte := to_number(substr(v1,posicion_pipe+1, s - posicion_pipe-1)); --consigo el cliente
      dbms_output.put_line('CLIENTE:');
      dbms_output.put_line(id_clte);
      /***sub bloque para validar que exista el cliente***/
      begin 
        select ID_CLIENTE into c_id_clte
        from BA_CLIENTE 
        WHERE ID_CLIENTE = id_clte;
      exception
        when no_data_found then --si no existe le asigno null 
          c_id_clte := NULL;
      end;
      /***sub bloque****/
     posicion_pipe := instr(v1, '|',s);
     posicion_pipe_sig := instr(v1,'|',s-1,2);
     s := posicion_pipe_sig;
     f_fecha := to_date(substr(v1,posicion_pipe+1,s - posicion_pipe-1)); --consigo la fecha
     dbms_output.put_line('FECHA:');
     dbms_output.put_line(f_fecha);
     posicion_pipe := instr(v1, '|',s);
     posicion_pipe_sig := instr(v1,'|',s-1,2);
     s := posicion_pipe_sig;
     f_valor := to_number(substr(v1,posicion_pipe+1,s - posicion_pipe-1)); --consigo el valor
     dbms_output.put_line('VALOR:');
     dbms_output.put_line(f_valor);
     posicion_pipe := instr(v1, '|',s);
     posicion_pipe_sig := instr(v1,'|',s-1,2);
     s := posicion_pipe_sig;
     f_estatus := to_char(substr(v1,posicion_pipe+1,s - posicion_pipe-1)); --consigo el estatus
     dbms_output.put_line('ESTATUS:');
     dbms_output.put_line(f_estatus);
     if c_id_clte is NULL and opcion = 1 then -- se pregunta si se encontro el cliente y si la opcion es 1 donde 1 es un SI para que se cree el cliente
      /******CREAR EL CLIENTE EN LA TABLA CLIENTE*****/
      insert into BA_CLIENTE values (id_clte, 'SIN NOMBRE');
     if sql%found then
      dbms_output.put_line('se inserto en la cliente'); 
     else
      dbms_output.put_line('no se inserto en la tabla cliente');
     end if;
     end if; --end if de la opcion 1 y c_id_clte = NULL
     if c_id_clte = id_clte and opcion = 1 then --verificar que el cliente existe y  que entre cuando la opcion no sea cero y se inserte en la tabla
      insert into BA_FACT_VTA values (f_folio, id_clte, f_fecha, f_valor, f_estatus);
      if sql%found then --valida que el insert en fact:vta se realizo
        dbms_output.put_line('se inserto en la tabla factura venta'); 
      else
        dbms_output.put_line('no se inserto en la tabla factura venta');
      end if; --fin de la validacion del insert
     end if;-- fin del fin cuando el cliente existe y opcion =1
     if c_id_clte is NULL and opcion = 0 then --se pregunta si se encontro el cliente y si la opcion es 0 para crear un archivo con los datos del cliente 
      f1 := utl_file.fopen ('URL_DIR','clientes_no_dados_de_alta.txt','a');
      dbms_output.put_line('SE INSERTO EN EL ARCHIVO LA CADENA:');
      dbms_output.put_line(v1);
      utl_file.put_line(f1,v1);
      dbms_output.put_line('al archivo'); 
     end if; --end if de c_id_clte = NULL and opcion = 0
  end if; --end if de la tabla = FP
  if tabla = 'PF' then --pregunto si es producto
      s := 3;
      posicion_pipe := instr(v1, '|');
      p_folio := to_number(substr(v1,3,posicion_pipe-3)); --consigo el folio
      dbms_output.put_line('FOLIO:');
      dbms_output.put_line(P_FOLIO);
      posicion_pipe_sig := instr(v1,'|',s-1,2);
      s := posicion_pipe_sig;
      p_prod := to_number(substr(v1,posicion_pipe+1, s - posicion_pipe-1)); --consigo el numero de producto
      dbms_output.put_line('PRODUCTO:');
      dbms_output.put_line(P_PROD);
      posicion_pipe := instr(v1, '|',s);
      posicion_pipe_sig := instr(v1,'|',s-1,2);
      s := posicion_pipe_sig;
      p_valor := to_number(substr(v1,posicion_pipe+1,s - posicion_pipe-1));--consigo el valor
      dbms_output.put_line('VALOR:');
      dbms_output.put_line(P_VALOR);
      posicion_pipe := instr(v1, '|',s);
      posicion_pipe_sig := instr(v1,'|',s-1,2);
      s := posicion_pipe_sig;
      p_cantidad := to_number(substr(v1,posicion_pipe+1,s - posicion_pipe-1)); --consigo la cantidad
      dbms_output.put_line('CANTIDAD:');
      dbms_output.put_line(P_CANTIDAD);
      if c_id_clte = id_clte and opcion =1 then --verificar que el cliente existe y  que entre cuando la opcion no sea cero y se inserte en la tabla
        insert into BA_PROD_VENTA values (p_folio, p_prod, p_valor, p_cantidad); --folio, prod,valor,cant
        if sql%found then --se valida si se realizo el insert en prod_venta
          dbms_output.put_line('se inserto en la tabla producto venta'); 
        else
          dbms_output.put_line('no se inserto en la tabla producto venta');
        end if; --fin del if si se realizo el insert en la tabla prod_venta
      end if;-- fin del if de la validacion del cliente si existe y opcion =1
      if c_id_clte is null and opcion = 0 then
        dbms_output.put_line('SE INSERTO EN EL ARCHIVO LA CADENA:');
        dbms_output.put_line(v1);
        utl_file.put_line (f1,v1);
      END IF; --FIN DEL if cuando se agrega al archivo
  end if; --fin del if = PF
--end if;
end loop; 
exception
when no_data_found then 
  utl_file.fclose(f2); 
  utl_file.fclose(f1);
  dbms_output.put_line('se termino de recorrer el archivo'); 
end;
/*****SE EJECUTA EL PROCEDURE*******/
begin
cargar (0);
end;
